name: iOS CI

on:
  pull_request:
  push:
    branches: [ main, develop, test/* ]

jobs:
  build-test:
    runs-on: macos-14

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install Bundler (Ruby dependencies)
      - name: Install Bundler
        run: gem install bundler

      # 3. Install Fastlane
      - name: Install Fastlane
        run: gem install fastlane

      # 4. Install Tuist
      - name: Install Tuist
        run: curl -Ls https://get.tuist.io | bash

      # 5. Add Tuist to PATH (GitHub runner 환경 문제 대응)
      - name: Add Tuist to PATH
        run: |
          echo "$HOME/.tuist/bin" >> $GITHUB_PATH
          echo "$HOME/.local/share/tuist/bin" >> $GITHUB_PATH
          echo "$HOME/.cache/tuist/bin" >> $GITHUB_PATH
          echo "/usr/local/bin" >> $GITHUB_PATH

      # 6. Verify Tuist installation
      - name: Verify Tuist installation
        run: tuist version

      # 7. Generate Xcode project
      - name: Generate project
        run: tuist generate --no-open

      # 8. Run Tests
      - name: Run Tests (Fastlane)
        run: fastlane test_ci

      # 9. Build App
      - name: Run Build (Fastlane)
        run: fastlane build_ci
